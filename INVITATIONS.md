# Система приглашений в бюджет — документация для фронтенда

> Базовый URL всех запросов: `/api`
> Все защищённые эндпоинты требуют заголовка `Authorization: Bearer <accessToken>`

---

## Модели данных

### BudgetInvitation

Таблица `BudgetInvitations`. Хранит приглашение в бюджет до момента принятия/отклонения.

| Поле          | Тип                                   | Описание                                                   |
|---------------|---------------------------------------|------------------------------------------------------------|
| `id`          | `UUID`                                | Идентификатор приглашения (он же токен в ссылке письма)   |
| `email`       | `string`                              | Email приглашённого пользователя                          |
| `role`        | `"editor" \| "viewer"`               | Роль, с которой пользователь войдёт в бюджет              |
| `status`      | `"pending" \| "accepted" \| "rejected"` | Текущий статус (по умолчанию `"pending"`)               |
| `budgetId`    | `UUID`                                | Бюджет, в который приглашают                              |
| `invitedById` | `UUID \| null`                        | `id` пользователя, который отправил приглашение           |
| `expiresAt`   | `ISO 8601 datetime`                   | Дата истечения (7 дней с момента создания)                |
| `createdAt`   | `ISO 8601 datetime`                   | Дата создания                                             |
| `updatedAt`   | `ISO 8601 datetime`                   | Дата последнего изменения                                 |

### BudgetMember

Таблица `BudgetMembers`. Подтверждённое членство пользователя в бюджете.

| Поле        | Тип                                | Описание                                         |
|-------------|------------------------------------|--------------------------------------------------|
| `id`        | `UUID`                             | Идентификатор записи                            |
| `role`      | `"owner" \| "editor" \| "viewer"` | Роль в бюджете                                  |
| `budgetId`  | `UUID`                             | Бюджет                                          |
| `userId`    | `UUID`                             | Пользователь                                    |
| `createdAt` | `ISO 8601 datetime`                | Дата вступления в бюджет                        |
| `updatedAt` | `ISO 8601 datetime`                | Дата последнего изменения                       |

### Иерархия ролей

```
viewer < editor < owner
```

- `viewer` — только чтение (транзакции, счета, категории, участники)
- `editor` — всё выше + создание/редактирование транзакций и счетов
- `owner` — всё выше + управление участниками и приглашениями, удаление бюджета

---

## Эндпоинты приглашений

### GET /budget-invitations

Список всех приглашений бюджета.

**Доступ:** участники бюджета с ролью `viewer` и выше.

**Query-параметры:**

| Параметр   | Тип    | Обязательный | Описание    |
|------------|--------|--------------|-------------|
| `budgetId` | `UUID` | да           | ID бюджета |

**Пример запроса:**
```
GET /api/budget-invitations?budgetId=<uuid>
Authorization: Bearer <token>
```

**Ответ `200`:** массив объектов `BudgetInvitation` (см. модель выше), отсортированных по `createdAt DESC`.

---

### GET /budget-invitations/:id

Получить одно приглашение по ID.

**Доступ:** участники бюджета с ролью `viewer` и выше.

**Ответ `200`:** объект `BudgetInvitation`.

**Ошибки:**

| HTTP | code                            | Описание                  |
|------|---------------------------------|---------------------------|
| 404  | `BUDGET_INVITATION_NOT_FOUND`   | Приглашение не найдено    |

---

### POST /budget-invitations

Создать и отправить приглашение.

**Доступ:** только `owner` бюджета.

**Body (JSON):**

```json
{
  "budgetId": "uuid",
  "email": "user@example.com",
  "role": "editor"
}
```

| Поле       | Тип                       | Обязательный | Описание                          |
|------------|---------------------------|--------------|-----------------------------------|
| `budgetId` | `UUID`                    | да           | ID бюджета                       |
| `email`    | `string`                  | да           | Email приглашаемого               |
| `role`     | `"editor" \| "viewer"`   | да           | Роль (owner нельзя назначить)     |

**Поведение:**
- Если пользователь с таким email уже является участником бюджета → `409 ALREADY_BUDGET_MEMBER`
- Если уже есть активное (`pending`) приглашение на этот email в этот бюджет → `409 ALREADY_INVITED`
- После создания автоматически отправляется email со ссылкой вида:
  `{FRONTEND_URL}/invitations/accept?token=<invitationId>`
- Срок действия приглашения — **7 дней**

**Ответ `201`:** объект `BudgetInvitation`.

**Ошибки:**

| HTTP | code                    | Описание                                    |
|------|-------------------------|---------------------------------------------|
| 400  | `VALIDATION_ERROR`      | Не переданы обязательные поля               |
| 400  | `INVALID_ROLE`          | Недопустимая роль                           |
| 409  | `ALREADY_BUDGET_MEMBER` | Пользователь уже участник бюджета           |
| 409  | `ALREADY_INVITED`       | Уже есть активное приглашение на этот email |

---

### PATCH /budget-invitations/:id

Изменить роль в приглашении.

**Доступ:** только `owner` бюджета.

**Ограничения:** только пока `status === "pending"`. Нельзя менять `budgetId` и `status`.

**Body (JSON):**

```json
{
  "role": "viewer"
}
```

| Поле   | Тип                      | Обязательный | Описание  |
|--------|--------------------------|--------------|-----------|
| `role` | `"editor" \| "viewer"`  | нет          | Новая роль |

**Ответ `200`:** обновлённый объект `BudgetInvitation`.

**Ошибки:**

| HTTP | code                          | Описание                             |
|------|-------------------------------|--------------------------------------|
| 400  | `INVITATION_NOT_PENDING`      | Приглашение уже принято/отклонено    |
| 400  | `INVALID_ROLE`                | Недопустимая роль                    |
| 404  | `BUDGET_INVITATION_NOT_FOUND` | Приглашение не найдено               |

---

### DELETE /budget-invitations/:id

Отозвать приглашение (удалить).

**Доступ:** только `owner` бюджета.

**Ответ `204`:** пустой ответ.

---

### POST /budget-invitations/:id/accept

Принять приглашение. Вызывается самим приглашённым пользователем.

> **Важно:** этот эндпоинт НЕ требует членства в бюджете. Требуется только авторизация (`Authorization: Bearer <token>`). Именно на него ведёт ссылка из письма.

**Доступ:** любой авторизованный пользователь, email которого совпадает с `invitation.email`.

**URL-параметры:**

| Параметр | Тип    | Описание                                                               |
|----------|--------|------------------------------------------------------------------------|
| `id`     | `UUID` | ID приглашения (передаётся в ссылке из письма как параметр `token`)   |

**Поведение:**
- Проверяет, что `invitation.email === user.email` (case-insensitive)
- Проверяет, что приглашение не истекло (`expiresAt > now`)
- Атомарно создаёт `BudgetMember` и ставит `status = "accepted"`

**Ответ `200`:**

```json
{
  "budgetId": "uuid",
  "role": "editor"
}
```

**Ошибки:**

| HTTP | code                          | Описание                                         |
|------|-------------------------------|--------------------------------------------------|
| 400  | `INVITATION_NOT_PENDING`      | Приглашение уже принято или отклонено            |
| 400  | `INVITATION_EXPIRED`          | Срок действия приглашения истёк                  |
| 403  | `INVITATION_EMAIL_MISMATCH`   | Email текущего пользователя не совпадает         |
| 404  | `BUDGET_INVITATION_NOT_FOUND` | Приглашение не найдено                           |
| 409  | `ALREADY_BUDGET_MEMBER`       | Пользователь уже является участником бюджета     |

---

### POST /budget-invitations/:id/reject

Отклонить приглашение. Вызывается самим приглашённым пользователем.

**Доступ:** любой авторизованный пользователь, email которого совпадает с `invitation.email`.

**Поведение:** ставит `status = "rejected"`. `BudgetMember` не создаётся.

**Ответ `200`:**

```json
{
  "ok": true
}
```

**Ошибки:**

| HTTP | code                          | Описание                                     |
|------|-------------------------------|----------------------------------------------|
| 400  | `INVITATION_NOT_PENDING`      | Приглашение уже принято или отклонено        |
| 403  | `INVITATION_EMAIL_MISMATCH`   | Email текущего пользователя не совпадает     |
| 404  | `BUDGET_INVITATION_NOT_FOUND` | Приглашение не найдено                       |

---

## Эндпоинты участников бюджета

### GET /budget-members

Список участников бюджета.

**Доступ:** `viewer` и выше.

**Query:** `?budgetId=<uuid>`

**Ответ `200`:** массив объектов `BudgetMember`, отсортированных по `createdAt ASC`.

---

### GET /budget-members/:id

**Доступ:** `viewer` и выше.

**Ответ `200`:** объект `BudgetMember`.

---

### PATCH /budget-members/:id

Изменить роль участника.

**Доступ:** только `owner`.

**Body:**

```json
{
  "role": "viewer"
}
```

**Ограничения:**
- Нельзя понизить роль последнего `owner` — вернёт `400 LAST_OWNER_PROTECTED`
- `role` — обязательное поле

**Ответ `200`:** обновлённый объект `BudgetMember`.

---

### DELETE /budget-members/:id

Удалить участника из бюджета.

**Доступ:** только `owner`.

**Ограничения:** нельзя удалить последнего `owner` — вернёт `400 LAST_OWNER_PROTECTED`.

**Ответ `204`:** пустой ответ.

---

## Формат ошибок

Все ошибки возвращаются в едином формате:

```json
{
  "error": {
    "code": "ALREADY_INVITED",
    "message": "Invitation already sent to this email"
  }
}
```

---

## Флоу приглашения — сценарии для фронтенда

### Сценарий A: приглашение зарегистрированного пользователя

```
1. Owner → POST /api/budget-invitations { budgetId, email, role }
   ← 201: invitation создана, письмо отправлено

2. Приглашённый открывает письмо, переходит по ссылке:
   {FRONTEND_URL}/invitations/accept?token=<invitation.id>

3. Фронтенд читает token из URL → показывает страницу с деталями приглашения
   (можно показать данные invitation: budgetName загрузить отдельно, role)

4. Пользователь нажимает «Принять» →
   POST /api/budget-invitations/<token>/accept
   ← 200: { budgetId, role }
   → редирект на страницу бюджета

5. Пользователь нажимает «Отклонить» →
   POST /api/budget-invitations/<token>/reject
   ← 200: { ok: true }
```

### Сценарий B: приглашение незарегистрированного пользователя

```
1. Owner → POST /api/budget-invitations { budgetId, email, role }
   ← 201: письмо отправлено

2. Новый пользователь открывает письмо → переходит по ссылке:
   {FRONTEND_URL}/invitations/accept?token=<invitation.id>

3. Фронтенд видит, что пользователь не авторизован →
   редирект на страницу регистрации, сохранив token в localStorage / URL

4. Пользователь регистрируется →
   POST /api/auth/register { email, password, firstName, lastName }
   ← 201 + accessToken

   БЭКЕНД АВТОМАТИЧЕСКИ находит все pending-приглашения на этот email
   и создаёт BudgetMember → пользователь уже в бюджете

5. После успешной регистрации фронтенд читает token →
   POST /api/budget-invitations/<token>/accept
   ← 409 ALREADY_BUDGET_MEMBER (пользователь уже добавлен при регистрации)
   → можно трактовать 409 как успех и делать редирект на бюджет

   Либо: фронтенд проверяет наличие токена, и если 409 — просто редиректит.
```

### Управление приглашениями (для owner)

```
- Просмотр: GET /api/budget-invitations?budgetId=<id>
  (показывать pending/accepted/rejected с датой и email)

- Отзыв pending-приглашения: DELETE /api/budget-invitations/<id>

- Смена роли до принятия: PATCH /api/budget-invitations/<id> { role: "viewer" }
```

---

## Замечания по реализации фронтенда

1. **Страница `/invitations/accept`** должна работать в двух состояниях:
   - пользователь авторизован → показать кнопки «Принять» / «Отклонить»
   - пользователь не авторизован → редирект на `/register` с сохранением `?token=...`

2. **После регистрации** через ссылку приглашения — проверить наличие token в URL/localStorage и вызвать `POST /:id/accept`. Если ответ `409 ALREADY_BUDGET_MEMBER` — трактовать как успех (бэкенд добавил автоматически при регистрации).

3. **Истёкшее приглашение** (`400 INVITATION_EXPIRED`) — показать сообщение «Ссылка недействительна, попросите пригласить вас заново».

4. **Несовпадение email** (`403 INVITATION_EMAIL_MISMATCH`) — пользователь вошёл под другим аккаунтом. Показать: «Это приглашение предназначено для другого email».

5. **Список участников** — `GET /api/budget-members?budgetId=...` возвращает всех `BudgetMember`. Текущего пользователя можно определить по совпадению `userId` с `user.id` из accessToken (или из ответа `/auth/register` / `/auth/login`).
